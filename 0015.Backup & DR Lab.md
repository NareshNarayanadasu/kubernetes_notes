Excellent ðŸš€ Youâ€™ve reached **Day 28: Backup & Disaster Recovery (DR) Lab** â€” one of the **most critical real-world skills** in Kubernetes.

Imagine: A cluster crashes, nodes fail, or a namespace gets deleted â€” without proper backup & DR, **all stateful workloads, configs, secrets, and PVs could be lost**. Velero helps prevent this.

Letâ€™s go **step by step: Concepts â†’ Install â†’ Backup â†’ Restore â†’ Hands-on Lab â†’ Best practices â†’ Troubleshooting**.

---

# **Day 28: Backup & DR Lab**

---

## **1. Why Backup & DR in Kubernetes?**

* **Stateless apps** can be re-deployed from Git/CI.
* But **stateful apps** (databases, configs, secrets, PV data) need backup.
* Disaster Recovery (DR) ensures you can:

  * Recover after accidental deletion (namespace, resources, PVs).
  * Migrate workloads between clusters.
  * Restore after hardware/cloud failures.

ðŸ‘‰ Tools available: Velero, Kasten K10, Stash, etc.
ðŸ‘‰ Here we focus on **Velero** (open-source, widely used).

---

## **2. Velero Overview**

Velero (by VMware) provides:

* **Backup/restore** of Kubernetes resources and volumes.
* **Disaster recovery** â†’ Full cluster restore.
* **Cluster migration** â†’ Move apps between clusters.
* Works with cloud storage (S3, GCS, Azure Blob, MinIO).

---

## **3. Installing Velero**

### **3.1 Prerequisites**

* Kubernetes cluster (minikube, kind, EKS, GKE, AKS, etc).
* Storage bucket (S3/MinIO/etc) for storing backups.
* `velero` CLI installed locally.

ðŸ‘‰ Install CLI:

```bash
curl -L https://github.com/vmware-tanzu/velero/releases/download/v1.13.0/velero-v1.13.0-linux-amd64.tar.gz | tar -xz
sudo mv velero-v1.13.0-linux-amd64/velero /usr/local/bin/
```

ðŸ‘‰ Verify:

```bash
velero version
```

---

### **3.2 Install Velero in Cluster**

Example with AWS S3:

```bash
velero install \
    --provider aws \
    --plugins velero/velero-plugin-for-aws:v1.7.1 \
    --bucket my-velero-backups \
    --secret-file ./aws-credentials \
    --backup-location-config region=us-east-1 \
    --use-restic
```

ðŸ‘‰ For MinIO (local testing):

```bash
velero install \
    --provider aws \
    --plugins velero/velero-plugin-for-aws:v1.7.1 \
    --bucket velero \
    --secret-file ./minio-credentials \
    --backup-location-config region=minio,s3ForcePathStyle="true",s3Url=http://minio-service:9000 \
    --use-restic
```

---

## **4. Backup a Namespace**

### **4.1 Take Backup**

```bash
velero backup create dev-backup --include-namespaces dev
```

ðŸ‘‰ Backup `dev` namespace resources + PVs.

### **4.2 Check Backup Status**

```bash
velero backup get
velero backup describe dev-backup --details
```

---

## **5. Restore from Backup**

### **5.1 Delete Namespace**

```bash
kubectl delete ns dev
```

ðŸ‘‰ Simulate accidental deletion.

### **5.2 Restore**

```bash
velero restore create --from-backup dev-backup
```

ðŸ‘‰ This recreates namespace, deployments, secrets, PVCs, PVs, etc.

### **5.3 Verify**

```bash
kubectl get ns
kubectl get all -n dev
```

ðŸ‘‰ Should show resources back in place âœ…

---

## **6. Hands-On Lab Flow**

1. Install Velero in cluster.
2. Deploy a sample app in `dev` namespace (e.g., NGINX + PVC).
3. Take a backup:

   ```bash
   velero backup create dev-backup --include-namespaces dev
   ```
4. Delete the namespace:

   ```bash
   kubectl delete ns dev
   ```
5. Restore it:

   ```bash
   velero restore create --from-backup dev-backup
   ```
6. Verify PVC data persistence.

---

## **7. Best Practices**

âœ… Always back up **namespaces with critical apps** (DBs, configs, secrets).
âœ… Schedule automated backups:

```bash
velero schedule create daily-backup --schedule "0 2 * * *" --include-namespaces prod
```

âœ… Store backups in **remote/cloud storage** (not same cluster).
âœ… Encrypt backups for security.
âœ… Test restores regularly (donâ€™t just trust backups).
âœ… Use **`--use-restic`** for PV backups if CSI snapshot is unavailable.

---

## **8. Troubleshooting**

* **PVCs not backed up** â†’ Ensure `restic` or CSI snapshots enabled.
* **Restore fails** â†’ Check storage class differences across clusters.
* **Backup stuck in InProgress** â†’ Check Velero pod logs:

  ```bash
  kubectl logs deployment/velero -n velero
  ```
* **Cloud provider auth issues** â†’ Validate credentials in Velero secret.

---

## âœ… Key Takeaways

* Velero enables **Kubernetes resource + PV backups**.
* Supports **namespace-level, cluster-level, and scheduled backups**.
* Useful for **disaster recovery and cluster migration**.
* Always **test restore flow** â†’ Backup is only good if it restores correctly!

---

