Here’s a **detailed, text-only guide for Day 66–67: Security & Compliance**, covering every key concept, tool, and hands-on step for in-depth understanding.

---

# **Day 66–67: Security & Compliance in Kubernetes**

---

## **1. Lab Objective**

* Audit Kubernetes clusters for **security vulnerabilities and misconfigurations**.
* Understand **CIS Kubernetes Benchmark** and security best practices.
* Use tools like **kube-bench** and **kube-hunter**.
* Enforce **security policies** using Kubernetes-native controls.

---

## **2. Why Security & Compliance?**

* Kubernetes is a complex system with multiple components: **API server, kubelet, etcd, network, pods**.

* Misconfigurations can lead to:

  * Unauthorized access
  * Data breaches
  * Privilege escalation
  * Workload compromise

* Regulatory and compliance requirements demand adherence to standards such as:

  * **CIS Benchmarks**
  * **NIST / ISO27001**
  * **GDPR / HIPAA**

---

## **3. Key Concepts**

| Concept                      | Description                                                                             |
| ---------------------------- | --------------------------------------------------------------------------------------- |
| CIS Benchmark                | A set of security best practices for Kubernetes (control plane, worker nodes, policies) |
| Kube-bench                   | Tool to automatically check cluster against CIS benchmark                               |
| Kube-hunter                  | Security scanner to find vulnerabilities in live Kubernetes cluster                     |
| Pod Security Standards (PSS) | Enforce policies for pod security (privileged containers, hostPath, etc.)               |
| Network Policies             | Restrict traffic between pods and namespaces                                            |
| RBAC                         | Control access to Kubernetes resources using roles and bindings                         |

---

## **4. Tools for Cluster Security**

### **4.1 kube-bench**

* Audits the cluster **against CIS Kubernetes benchmark**.
* Checks for:

  * API server secure settings
  * Kubelet configurations
  * etcd security
  * RBAC policies

**Install kube-bench:**

```bash
kubectl apply -f https://raw.githubusercontent.com/aquasecurity/kube-bench/main/job.yaml
```

**Run the audit:**

```bash
kubectl logs -l job-name=kube-bench
```

* Output:

  * PASS, WARN, FAIL for each check
  * Example: `Ensure that the API server pod specification file permissions are set to 644 or more restrictive (PASS)`

---

### **4.2 kube-hunter**

* Runs **active and passive scanning** of live cluster for vulnerabilities.
* Detects:

  * Open API endpoints
  * Unsecured kubelets
  * Network exposure issues
  * Misconfigured RBAC

**Run kube-hunter in cluster mode:**

```bash
kubectl run -i --tty kube-hunter --image=aquasec/kube-hunter --restart=Never -- bash
kube-hunter --remote <cluster-IP>
```

* Output:

  * Categorized vulnerabilities (Critical, Medium, Low)
  * Recommendations for remediation

---

## **5. Enforcing Security Policies**

### **5.1 Pod Security Standards (PSS)**

* Kubernetes 1.22+ supports PSS using **namespaces**.
* Modes:

  * **Enforce**: Reject non-compliant pods
  * **Audit**: Log violations
  * **Warn**: Warn but allow pod creation

**Example: Enforce restricted pod security**

```yaml
apiVersion: policy/v1
kind: PodSecurityAdmissionConfiguration
metadata:
  name: restricted
spec:
  enforce:
    - level: restricted
      version: v1.24
  audit:
    - level: baseline
      version: v1.24
  warn:
    - level: baseline
      version: v1.24
```

* Apply labels to namespaces:

```bash
kubectl label ns secure-ns pod-security.kubernetes.io/enforce=restricted
```

---

### **5.2 Network Policies**

* Restrict pod-to-pod communication within the cluster.

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
  namespace: secure-ns
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress
```

* Apply **allow rules** for specific pods/services as needed.

---

### **5.3 RBAC Best Practices**

1. Use **least privilege** principle.
2. Avoid using **ClusterAdmin** unless necessary.
3. Define **Roles** and **RoleBindings** per namespace:

```bash
kubectl create role dev-role --verb=get,list,create --resource=pods -n secure-ns
kubectl create rolebinding dev-binding --role=dev-role --user=developer -n secure-ns
```

---

### **5.4 Image Security**

* Use **signed images** from trusted registries.
* Scan images with **Trivy**:

```bash
trivy image nginx:latest
```

* Detect vulnerabilities, outdated libraries, and CVEs.

---

## **6. Lab Workflow Example**

1. Deploy test namespace and workloads:

```bash
kubectl create ns secure-ns
kubectl apply -f nginx-deployment.yaml -n secure-ns
```

2. Run **kube-bench** to audit cluster:

```bash
kubectl apply -f kube-bench-job.yaml
kubectl logs -l job-name=kube-bench
```

3. Run **kube-hunter** to detect vulnerabilities:

```bash
kubectl run -i --tty kube-hunter --image=aquasec/kube-hunter --restart=Never -- bash
kube-hunter --remote <cluster-IP>
```

4. Enforce **Pod Security Standards** and **Network Policies**:

```bash
kubectl label ns secure-ns pod-security.kubernetes.io/enforce=restricted
kubectl apply -f deny-all-networkpolicy.yaml -n secure-ns
```

5. Test RBAC restrictions and image scanning.

---

## **7. Key Security Concepts Recap**

| Area          | Key Actions                                    |
| ------------- | ---------------------------------------------- |
| Control Plane | Secure API server, use RBAC, enable audit logs |
| Kubelet       | Enable authentication & authorization, TLS     |
| Etcd          | Encrypt data at rest, restrict access          |
| Pods          | Use PSS, Network Policies, non-root containers |
| Images        | Scan and sign images before deployment         |
| Cluster Audit | Regular audits with kube-bench/kube-hunter     |

---

## **8. Best Practices**

1. Regularly run **kube-bench** to check CIS compliance.
2. Perform **penetration testing** using **kube-hunter**.
3. Apply **least privilege RBAC** and **Pod Security Standards**.
4. Isolate workloads with **namespaces and network policies**.
5. Automate image scanning in **CI/CD pipeline**.
6. Keep **Kubernetes and dependencies up to date**.

---

## **9. Troubleshooting Security Issues**

| Issue                          | Solution                                                  |
| ------------------------------ | --------------------------------------------------------- |
| Non-compliant pods fail        | Check PSS policies and audit logs                         |
| NetworkPolicy blocking traffic | Verify selectors, pod labels, namespace labels            |
| kube-bench errors              | Ensure correct CIS benchmark version for cluster          |
| kube-hunter network scan fails | Ensure cluster network is reachable, check firewall rules |
| RBAC access denied             | Review roles, bindings, and user context                  |

---

## **10. Lab Summary**

* Learned **cluster security auditing** using kube-bench and kube-hunter.
* Applied **Pod Security Standards, Network Policies, and RBAC**.
* Scanned container images for vulnerabilities using **Trivy**.
* Enforced compliance and hardened Kubernetes workloads.

✅ **Outcome:**

* Understand how to **audit, secure, and enforce policies** in Kubernetes.
* Ability to identify **misconfigurations, vulnerabilities, and enforce best practices**.
* Ready to implement **production-grade secure clusters**.

---


