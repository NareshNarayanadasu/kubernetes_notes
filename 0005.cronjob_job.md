Perfect! Let’s dive into **Day 7: Jobs & CronJobs** in **full depth**, covering **every concept, use case, workflow, YAML, and best practices**.

---

# **Day 7: Jobs & CronJobs – In-Depth Guide**

Kubernetes **Jobs and CronJobs** are used for **batch and scheduled workloads**, rather than long-running services. They are crucial for automating tasks like backups, ETL, or report generation.

---

## **1. Jobs**

### **1.1 What is a Job?**

* A **Job** creates **one or more pods** and ensures that a **specified number of them successfully terminate**.
* Pods created by Jobs are **temporary** and will terminate after completion.
* Jobs **track completion** and ensure all tasks are finished, retrying if necessary.

### **1.2 Types of Jobs**

| Type                           | Description                                                                  |
| ------------------------------ | ---------------------------------------------------------------------------- |
| **Non-parallel Job (default)** | Runs a single pod to completion.                                             |
| **Parallel Jobs**              | Runs multiple pods in parallel.                                              |
| **Indexed Jobs**               | Assigns an **index** to each pod for parallel execution (Job array pattern). |

---

### **1.3 Key Job Features**

* **Completions:** Number of successful completions required.
* **Parallelism:** Number of pods to run simultaneously.
* **Restart Policy:** Usually `Never` or `OnFailure`.
* **Backoff Limit:** How many times a failed pod will be retried before Job is considered failed.

---

### **1.4 Job YAML Example**

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: hello-job
spec:
  completions: 1
  parallelism: 1
  backoffLimit: 4
  template:
    spec:
      containers:
      - name: hello
        image: busybox
        command: ["echo", "Hello Kubernetes Jobs"]
      restartPolicy: Never
```

**Commands:**

```bash
kubectl apply -f job.yaml
kubectl get jobs
kubectl get pods
kubectl logs job/hello-job
```

**Explanation:**

* `completions`: Job completes after **1 pod succeeds**.
* `parallelism`: Number of pods running at the same time.
* `restartPolicy: Never`: Completed pods are not restarted.

---

### **1.5 Parallel Jobs Example**

```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: parallel-job
spec:
  completions: 5
  parallelism: 2
  template:
    spec:
      containers:
      - name: worker
        image: busybox
        command: ["sh", "-c", "echo Hello Pod $(hostname); sleep 5"]
      restartPolicy: Never
```

* Runs 2 pods at a time.
* Completes when **5 successful pods** finish.

---

## **2. CronJobs**

### **2.1 What is a CronJob?**

* CronJobs are **scheduled Jobs**, similar to Unix cron.
* Automatically creates **Jobs at specified times**.
* Useful for tasks like:

  * Database backup
  * Log cleanup
  * Batch processing
  * Sending reports

---

### **2.2 CronJob Schedule Format**

* Follows standard cron syntax:

```
* * * * * 
| | | | |
| | | | └─ day of week (0-7, 0 or 7 = Sunday)
| | | └── month (1-12)
| | └─── day of month (1-31)
| └──── hour (0-23)
└───── minute (0-59)
```

* Example:

  * `*/5 * * * *` → every 5 minutes
  * `0 0 * * *` → every day at midnight

---

### **2.3 CronJob YAML Example**

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: hello-cron
spec:
  schedule: "*/1 * * * *" # every minute for testing
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox
            command: ["echo", "Hello from CronJob"]
          restartPolicy: Never
```

**Commands:**

```bash
kubectl apply -f cronjob.yaml
kubectl get cronjobs
kubectl get jobs
kubectl get pods
kubectl logs job/<job-name>
```

**Explanation:**

* CronJob creates a new Job on schedule.
* Each Job creates one or more pods according to its spec.
* Completed pods can be cleaned up automatically via `successfulJobsHistoryLimit` and `failedJobsHistoryLimit`:

```yaml
successfulJobsHistoryLimit: 3
failedJobsHistoryLimit: 1
```

---

### **2.4 CronJob Best Practices**

* **Never run long jobs that overlap:** Use concurrencyPolicy to control behavior:

```yaml
concurrencyPolicy: Forbid # prevents overlapping jobs
# Options: Allow, Forbid, Replace
```

* Limit history of completed/failed Jobs to save resources:

```yaml
successfulJobsHistoryLimit: 3
failedJobsHistoryLimit: 1
```

* Always use **restartPolicy: Never** to prevent unwanted pod restarts.

---

### **3. Hands-On Lab Summary**

1. **Create a Job**

```bash
kubectl apply -f job.yaml
kubectl get jobs
kubectl get pods
kubectl logs job/hello-job
```

2. **Create a CronJob**

```bash
kubectl apply -f cronjob.yaml
kubectl get cronjobs
kubectl get jobs
kubectl get pods
kubectl logs job/<job-name>
```

3. **Test Completion**

* Check the Job status:

```bash
kubectl describe job hello-job
```

* Check CronJob schedule and logs:

```bash
kubectl describe cronjob hello-cron
kubectl logs job/<cronjob-generated-job-name>
```

4. **Advanced CronJob Testing**

* Schedule every minute for testing.
* Verify multiple jobs are created sequentially or concurrently based on `concurrencyPolicy`.

---

### **4. Key Takeaways**

* **Job:** Run a pod(s) to completion; guarantees success.
* **CronJob:** Schedule jobs periodically using cron syntax.
* **RestartPolicy:** Must be `Never` or `OnFailure`.
* **Parallelism & Completions:** Control number of pods and completions.
* **Concurrency Policy:** Avoid overlapping runs.
* **History Limits:** Keep cluster clean by limiting job history.

---

