Perfect üëå Let‚Äôs go **deep into Day 12‚Äì13: DNS & Network Policies**.
These are **must-know topics** for real-world Kubernetes troubleshooting and cluster security. I‚Äôll cover **CoreDNS (internal DNS), debugging DNS failures, and NetworkPolicies (pod-level firewalls)** with detailed examples.

---

# **Day 12‚Äì13: DNS & Network Policies ‚Äì Complete Guide**

---

## **1. Kubernetes DNS (CoreDNS)**

### **1.1 What is CoreDNS?**

* Kubernetes uses **CoreDNS** as the default **cluster DNS server**.
* Runs as a **Deployment in kube-system namespace**.
* Automatically assigns DNS names to:

  * **Services** ‚Üí `myservice.mynamespace.svc.cluster.local`
  * **Pods** (if enabled) ‚Üí `<pod-ip>.namespace.pod.cluster.local`
* Integrated with **KubeDNS** earlier, but now CoreDNS is default.

---

### **1.2 DNS Naming in Kubernetes**

* Full DNS format:

  ```
  <service-name>.<namespace>.svc.cluster.local
  ```
* Examples:

  * Service `nginx` in `default` namespace ‚Üí `nginx.default.svc.cluster.local`
  * Short DNS works too (`nginx` if inside same namespace).

---

### **1.3 Check CoreDNS Pods**

```bash
kubectl get pods -n kube-system -l k8s-app=kube-dns
kubectl describe pod -n kube-system <coredns-pod>
```

---

### **1.4 Debugging DNS Issues**

1. **Check CoreDNS logs**

   ```bash
   kubectl logs -n kube-system -l k8s-app=kube-dns
   ```

2. **Exec into a pod & test DNS**

   ```bash
   kubectl run dns-test --image=busybox:1.28 -it --rm --restart=Never -- nslookup nginx
   ```

3. **Check resolv.conf inside pod**

   ```bash
   kubectl exec -it <pod> -- cat /etc/resolv.conf
   ```

‚úÖ **If DNS fails:**

* CoreDNS pod crash? Restart it.
* kube-dns service missing? Recreate CoreDNS deployment.
* Network plugin (CNI) misconfigured? Fix routing.

---

## **2. Network Policies**

### **2.1 What are Network Policies?**

* By default ‚Üí **all pods can talk to all pods** (open network).
* **NetworkPolicy = firewall rules for pods**.
* Define **who can talk to whom** at Layer 3/4 (IP/port).
* Requires a **CNI plugin that supports policies**:

  * **Calico, Cilium, Weave Net** ‚úÖ
  * **Flannel** ‚ùå (doesn‚Äôt support NetworkPolicy by default).

---

### **2.2 Components of NetworkPolicy**

* **podSelector** ‚Üí which pods the policy applies to.
* **ingress** ‚Üí incoming traffic rules.
* **egress** ‚Üí outgoing traffic rules.
* **from/to** ‚Üí allowed sources/destinations.

---

### **2.3 Example: Deny All Traffic**

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-all
  namespace: default
spec:
  podSelector: {}   # Applies to ALL pods in namespace
  policyTypes:
  - Ingress
  - Egress
```

üëâ This blocks all pod communication.

---

### **2.4 Example: Allow Only Ingress from Specific Pod**

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-to-backend
  namespace: default
spec:
  podSelector:
    matchLabels:
      app: backend   # policy applies to backend pods
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
    ports:
    - protocol: TCP
      port: 80
```

üëâ Only `frontend` pods can talk to `backend` on port 80.

---

### **2.5 Example: Egress Policy (Allow to External World)**

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-external
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
  - Egress
  egress:
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0   # allow all external IPs
    ports:
    - protocol: TCP
      port: 443
```

üëâ `frontend` pods can only go **outbound to internet over HTTPS**.

---

### **2.6 Hands-On Lab**

1. **Deploy frontend + backend pods**

```bash
kubectl run frontend --image=nginx --labels="app=frontend"
kubectl run backend --image=nginx --labels="app=backend"
```

2. **Verify connectivity (before policy)**

```bash
kubectl exec -it frontend -- curl backend
```

3. **Apply deny-all policy**

```bash
kubectl apply -f deny-all.yaml
kubectl exec -it frontend -- curl backend   # ‚ùå should fail
```

4. **Apply allow-frontend-to-backend policy**

```bash
kubectl apply -f allow-frontend-to-backend.yaml
kubectl exec -it frontend -- curl backend   # ‚úÖ works
```

---

## **3. Troubleshooting Network Policies**

* If **policy exists**, pods **can‚Äôt communicate unless explicitly allowed**.
* Common mistakes:

  * Forgetting **ports** ‚Üí connection still blocked.
  * Applying in **wrong namespace**.
  * Using CNI that doesn‚Äôt support policies.

---

## **4. Key Takeaways**

* **CoreDNS** resolves services ‚Üí `<service>.<namespace>.svc.cluster.local`.
* Use `nslookup` or `dig` inside a pod to debug DNS.
* **NetworkPolicies** = Kubernetes firewalls.
* Default = **all allowed**; once you add a policy, default becomes **deny** unless allowed.
* Requires a **CNI plugin with NetworkPolicy support**.

---

