Here’s a **complete, in-depth guide for Day 59–60: Operators**, fully textual and detailed for understanding and hands-on practice.

---

# **Day 59–60: Kubernetes Operators**

---

## **1. Lab Objective**

* Understand what **Kubernetes Operators** are and why they exist.
* Install and use a **sample operator** (e.g., **etcd operator**).
* Automate operational tasks, such as **database backups**, using operators.

---

## **2. What is an Operator?**

* Operators are **custom controllers** that extend Kubernetes functionality.
* They encode **domain-specific knowledge** for managing complex applications.
* Example: managing **databases, message queues, or stateful applications**.

**Core idea:**

> “An Operator is a controller + CRD + domain knowledge.”

**Key features:**

1. Automates **installation, scaling, upgrades, and backup**.
2. Monitors application state and reconciles automatically.
3. Works with **Custom Resources**.

---

## **3. Operator Architecture**

| Component             | Function                                                        |
| --------------------- | --------------------------------------------------------------- |
| CRD (Custom Resource) | Defines desired state of the app (e.g., `EtcdCluster`)          |
| Operator/Controller   | Watches CR events and reconciles cluster to match desired state |
| Custom Resource       | Instance of CRD, e.g., an actual etcd cluster                   |
| Kubernetes API        | Allows operator to interact with Kubernetes resources           |

**Workflow:**

1. User applies a CR (e.g., `EtcdCluster`).
2. Operator watches CR events.
3. Operator reconciles actual state to match desired state (creates Pods, Services, PVs, etc.).
4. Operator can perform lifecycle tasks like backup, restore, scaling, or upgrades.

---

## **4. Hands-on: Install a Sample Operator**

### **4.1 Install etcd Operator**

* Use Operator Lifecycle Manager (OLM) or kubectl directly.

```bash
kubectl create namespace etcd-operator
kubectl apply -f https://github.com/etcd-io/etcd-operator/releases/download/v0.9.4/etcd-operator.yaml
```

* Verify deployment:

```bash
kubectl get pods -n etcd-operator
kubectl get deployments -n etcd-operator
```

---

## **5. Deploy an Etcd Cluster Using Operator**

### **5.1 Define EtcdCluster Custom Resource**

```yaml
apiVersion: etcd.database.coreos.com/v1beta2
kind: EtcdCluster
metadata:
  name: example-etcd
  namespace: default
spec:
  size: 3
  version: "3.5.0"
  backup:
    backupStore:
      s3:
        bucket: "my-etcd-backups"
        prefix: "etcd-backup"
        region: "us-east-1"
```

* Save as `etcd-cluster.yaml`

### **5.2 Apply the CR**

```bash
kubectl apply -f etcd-cluster.yaml
```

* Operator automatically creates:

  * StatefulSet for etcd nodes
  * Services for client access
  * PVs if storage is configured
  * Backup schedule (if defined in CR)

---

## **6. Verify Operator Actions**

```bash
kubectl get etcdclusters
kubectl get pods
kubectl get svc
kubectl logs -f <etcd-operator-pod> -n etcd-operator
```

* Check that operator created all resources and backups are scheduled.

---

## **7. Automate Database Backup Using Operator**

* The `backup` section in CRD handles backups automatically.
* Example from above CR:

```yaml
backup:
  backupStore:
    s3:
      bucket: "my-etcd-backups"
      prefix: "etcd-backup"
      region: "us-east-1"
```

* Operator will:

  1. Periodically backup etcd cluster to S3.
  2. Maintain snapshot retention.
  3. Restore snapshots if required.

**Verify backups:**

```bash
kubectl get pods
# Check backup pods created by operator
kubectl logs <backup-pod-name>
```

---

## **8. Advanced Operator Concepts**

| Feature          | Description                                                     |
| ---------------- | --------------------------------------------------------------- |
| Reconciliation   | Operator continually ensures desired state matches actual state |
| Version upgrades | Operator can upgrade managed application automatically          |
| Health checks    | Operator monitors and repairs application if it fails           |
| Backup & restore | Operators automate operational tasks like database backups      |
| RBAC             | Operators require proper permissions to manage resources        |

---

## **9. Operator Best Practices**

1. Use **operators for stateful applications** to automate lifecycle tasks.
2. Always define **backup policies** in CR.
3. Monitor operator logs for **reconciliation failures**.
4. Test operators in **dev clusters** before production.
5. Ensure operator has **least-privilege RBAC** for security.
6. Combine with **Velero or cloud snapshots** for DR.

---

## **10. Troubleshooting Operator Issues**

| Issue                    | Solution                                                 |
| ------------------------ | -------------------------------------------------------- |
| Operator pod not running | Check logs: `kubectl logs -n etcd-operator <pod>`        |
| CR not reconciled        | Verify CR spec and operator logs                         |
| Backup not happening     | Check S3 credentials or backup configuration in CR       |
| PVs not created          | Ensure storage class exists and operator has permissions |

---

## **11. Lab Summary**

* Learned **what Kubernetes Operators are** and their purpose.
* Installed **etcd operator** and deployed a cluster using CR.
* Operator automated **scaling, PV creation, and backup**.
* Hands-on practice with **CRs + operator automation**.
* Learned advanced operational automation for **stateful apps**.

---

✅ **Outcome:**

* Understand **operator architecture** and workflow.
* Ability to deploy **custom operators**.
* Automate **DB backup and recovery** using Kubernetes-native patterns.
* Ready to extend operators to other apps (e.g., MySQL, Kafka, MongoDB).


