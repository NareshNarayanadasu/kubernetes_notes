Awesome ðŸš€ Letâ€™s go into **Day 16â€“17: Persistent Volumes (PV) & Persistent Volume Claims (PVC)**.
Storage is **critical** for Kubernetes â€” because by default, pods are **ephemeral** and lose all data when restarted. PV & PVC provide a way to **persist application data** across pod restarts, upgrades, and rescheduling.

Iâ€™ll break it down step by step with **concepts â†’ YAML â†’ hands-on â†’ best practices**.

---

# **Day 16â€“17: Persistent Volumes & Persistent Volume Claims (Storage Management)**

---

## **1. Why Persistent Storage in Kubernetes?**

* **Problem:** Pods are temporary â†’ if they die, data stored inside their container filesystem is lost.
* **Solution:** Use **Persistent Volumes (PV)** & **Persistent Volume Claims (PVC)** to decouple **storage lifecycle from pod lifecycle**.

---

## **2. Storage Options in Kubernetes**

* **emptyDir** â†’ ephemeral, deleted when pod dies.
* **hostPath** â†’ pod mounts a directory from node (not portable).
* **PersistentVolume (PV)** â†’ cluster-wide storage resource (NFS, EBS, GCE Persistent Disk, Ceph, etc.).
* **PersistentVolumeClaim (PVC)** â†’ request storage from PV.
* **StorageClass** â†’ defines **dynamic provisioning** (cloud-native, auto-created PVs).

---

## **3. PersistentVolume (PV)**

### **3.1 What is a PV?**

* Cluster-wide storage resource.
* Admin creates it **or** dynamically provisioned via StorageClass.
* Has attributes:

  * **Capacity** (size, e.g., 5Gi)
  * **Access Modes**:

    * `ReadWriteOnce` (RWO) â†’ one node read/write
    * `ReadOnlyMany` (ROX) â†’ many nodes read-only
    * `ReadWriteMany` (RWX) â†’ many nodes read/write
  * **Reclaim Policy**:

    * `Retain` â†’ data stays even after claim released
    * `Delete` â†’ volume deleted after claim
    * `Recycle` (deprecated)

---

### **3.2 PV YAML Example**

```yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-demo
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  hostPath:   # using node local path (for demo only)
    path: "/mnt/data"
```

---

## **4. PersistentVolumeClaim (PVC)**

### **4.1 What is a PVC?**

* PVC = request for storage by a pod.
* User specifies **size, access mode**, not physical details.
* K8s matches PVC with available PV (binding).

---

### **4.2 PVC YAML Example**

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-demo
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
```

---

## **5. Pod Using PVC**

### **5.1 Pod YAML Example**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: pvc-pod
spec:
  containers:
  - name: app
    image: busybox
    command: ["sh", "-c", "echo 'Hello from PVC' > /data/hello.txt && sleep 3600"]
    volumeMounts:
    - name: storage
      mountPath: /data
  volumes:
  - name: storage
    persistentVolumeClaim:
      claimName: pvc-demo
```

ðŸ‘‰ Pod writes to `/data/hello.txt`. Even if pod is deleted and recreated, data remains in PV.

---

## **6. StorageClass (Dynamic Provisioning)**

### **6.1 Why StorageClass?**

* Manually creating PVs is not scalable.
* **StorageClass automates PV creation** when PVC is requested.
* Works with cloud providers (AWS EBS, GCP PD, Azure Disk) or on-prem solutions (Ceph, GlusterFS).

---

### **6.2 StorageClass YAML Example**

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard
provisioner: kubernetes.io/aws-ebs   # example for AWS
parameters:
  type: gp2
reclaimPolicy: Delete
```

---

### **6.3 PVC with StorageClass**

```yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: dynamic-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
  storageClassName: standard
```

ðŸ‘‰ When applied, Kubernetes automatically provisions an **EBS volume** (if on AWS).

---

## **7. Hands-On Lab**

### **Step 1: Create PV**

```bash
kubectl apply -f pv.yaml
kubectl get pv
```

### **Step 2: Create PVC**

```bash
kubectl apply -f pvc.yaml
kubectl get pvc
```

### **Step 3: Bind PV to PVC**

```bash
kubectl describe pvc pvc-demo
```

ðŸ‘‰ Status should be **Bound**.

### **Step 4: Attach PVC to Pod**

```bash
kubectl apply -f pvc-pod.yaml
kubectl exec -it pvc-pod -- cat /data/hello.txt
```

ðŸ‘‰ Data persists even if pod restarts.

---

## **8. Reclaim Policies**

| Policy  | Behavior                             |
| ------- | ------------------------------------ |
| Retain  | Keeps data, must be manually cleaned |
| Delete  | Deletes volume after PVC is removed  |
| Recycle | Wipes volume (deprecated, avoid)     |

---

## **9. Best Practices**

* Always use **StorageClass for dynamic provisioning**.
* Choose correct **AccessMode** (RWO vs RWX).
* Use `Retain` for critical data (databases).
* Use `Delete` for temporary workloads.
* Monitor PVC usage with:

  ```bash
  kubectl describe pvc <name>
  kubectl get pv,pvc
  ```

---

## **10. Key Takeaways**

* **PV** â†’ cluster-level storage resource.
* **PVC** â†’ pod request for storage.
* **StorageClass** â†’ dynamic provisioning.
* Pods use storage by mounting PVCs.
* **Reclaim policies** determine data lifecycle.

---

