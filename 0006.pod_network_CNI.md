Perfect! Let’s go **deep into Day 8–9: Pod Networking & CNI**, covering **every concept, how networking works internally, service types, CNI plugins, and hands-on testing**.

---

# **Day 8–9: Pod Networking & CNI – In-Depth Guide**

Kubernetes networking is one of the **most critical topics**. Pods communicate with each other, services expose pods, and networking must scale across nodes. Understanding **ClusterIP, NodePort, LoadBalancer, and CNI plugins** is essential.

---

## **1. Kubernetes Pod Networking**

### **1.1 Kubernetes Networking Requirements**

Kubernetes networking has **three basic requirements**:

1. **Pod-to-Pod Communication:**

   * Every pod must be able to communicate with every other pod without NAT.
   * Pods get a **unique IP** in the cluster.

2. **Pod-to-Node Communication:**

   * Nodes can reach pods on the same node or across nodes.

3. **External Access:**

   * Pods can communicate with the outside world (internet).
   * External clients can access pods via **Services**.

**Key Concept:** Kubernetes assumes **flat networking**—every pod has its own IP and can reach any other pod.

---

### **1.2 Pod-to-Pod Communication**

* Pods on the **same node** communicate directly via host networking.
* Pods on **different nodes** communicate via **overlay networks** (CNI plugin handles routing encapsulation).

**Test Pod-to-Pod connectivity:**

```bash
kubectl exec -it pod1 -- ping <pod2-IP>
```

---

## **2. Services – Exposing Pods**

Kubernetes **Services** provide **stable endpoints** for pods. Pods are ephemeral, so Services decouple access from pod lifecycle.

### **2.1 Service Types**

| Type             | Description                                   | Use Case                                        |
| ---------------- | --------------------------------------------- | ----------------------------------------------- |
| **ClusterIP**    | Internal IP, accessible only inside cluster   | Default service type for internal microservices |
| **NodePort**     | Opens a port on each node for external access | Simple external access for testing              |
| **LoadBalancer** | Requests cloud provider to provision LB       | Production external access                      |
| **ExternalName** | Maps service to external DNS                  | Access external resources                       |

---

### **2.2 ClusterIP**

* Default type
* Assigns **virtual IP** reachable only from inside cluster.
* Resolves via **Kubernetes DNS** (CoreDNS).

**Example YAML:**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-clusterip
spec:
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
  type: ClusterIP
```

**Test ClusterIP:**

```bash
kubectl get svc
kubectl exec -it <pod> -- curl nginx-clusterip
```

---

### **2.3 NodePort**

* Exposes service on **static port (30000-32767)** on each node.
* Access service using `<node-IP>:<NodePort>`.

**Example YAML:**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-nodeport
spec:
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
    nodePort: 31000
  type: NodePort
```

**Test NodePort:**

```bash
curl <node-IP>:31000
```

---

### **2.4 LoadBalancer**

* Requests **cloud provider LB** to expose service externally.
* Automatically creates NodePort + LB.
* Used in **AWS, GCP, Azure** clusters.

**Example YAML:**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-lb
spec:
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
  type: LoadBalancer
```

**Test LoadBalancer:**

```bash
kubectl get svc nginx-lb
# Use external IP from cloud provider
curl <external-ip>
```

---

## **3. Container Network Interface (CNI)**

### **3.1 What is CNI?**

* CNI is a **plugin interface** to configure pod networking.
* Handles:

  * IP allocation
  * Routing between pods
  * Network policies
* Kubernetes does **not provide networking itself**—requires a **CNI plugin**.

### **3.2 Popular CNI Plugins**

| CNI Plugin    | Features                                         |
| ------------- | ------------------------------------------------ |
| **Calico**    | L3 networking + NetworkPolicy, IP-in-IP or VXLAN |
| **Flannel**   | Simple overlay network, VXLAN or host-gw         |
| **Weave Net** | Encryption, overlay networking                   |
| **Cilium**    | L3/L4/L7 policies, eBPF-based networking         |
| **Canal**     | Calico + Flannel combo                           |

---

### **3.3 Installing CNI Plugins**

#### **Calico Example**

```bash
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
kubectl get pods -n calico-system
```

#### **Flannel Example**

```bash
kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
kubectl get pods -n kube-system
```

---

### **3.4 Network Policies**

* Define **which pods can communicate** with each other.
* Example: Allow traffic only from certain pods:

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-nginx
spec:
  podSelector:
    matchLabels:
      app: nginx
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: frontend
```

**Test Pod Isolation:**

```bash
kubectl exec -it pod1 -- ping pod2-IP
kubectl exec -it pod1 -- curl pod2-IP
```

---

## **4. Hands-On Lab Summary**

1. **Install CNI Plugin** (Calico/Flannel):

```bash
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
```

2. **Deploy two test pods**:

```bash
kubectl run pod1 --image=nginx
kubectl run pod2 --image=nginx
kubectl get pods -o wide
```

3. **Test pod-to-pod connectivity**:

```bash
kubectl exec -it pod1 -- ping <pod2-IP>
kubectl exec -it pod1 -- curl <pod2-IP>:80
```

4. **Create ClusterIP Service**:

```yaml
kubectl apply -f clusterip-service.yaml
kubectl exec -it pod1 -- curl nginx-clusterip
```

5. **Create NodePort Service**:

```yaml
kubectl apply -f nodeport-service.yaml
curl <node-IP>:31000
```

6. **Optional:** Apply NetworkPolicy and verify blocked/allowed traffic.

---

### **5. Key Takeaways**

* Kubernetes networking assumes **flat pod network**: every pod can reach every other pod.
* **CNI plugins** provide overlay networking, routing, and network policies.
* **Service types**:

  * ClusterIP → internal only
  * NodePort → external access via node
  * LoadBalancer → external access with cloud LB
* **NetworkPolicy** enables **pod-level security**.

---


