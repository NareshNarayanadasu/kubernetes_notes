Perfect ðŸ‘Œ Now letâ€™s go deep into **Day 19â€“20: Pod Security & Image Scanning**.
This part is **critical for securing workloads** in Kubernetes â€” making sure pods donâ€™t run with dangerous privileges and that container images are free from vulnerabilities.

Iâ€™ll break it down into **concepts â†’ YAML â†’ hands-on â†’ security â†’ best practices â†’ troubleshooting**.

---

# **Day 19â€“20: Pod Security & Image Scanning**

---

## **1. Why Pod Security Matters?**

* By default, Kubernetes allows **privileged operations** if not restricted.
* Attackers can:

  * Escalate privileges
  * Mount host filesystems
  * Run as root
  * Escape containers
* We must enforce **security controls on pods**:

  1. **Pod Security Standards (PSS)** â†’ built-in admission checks.
  2. **Admission Controllers (OPA, Kyverno, Gatekeeper)** â†’ advanced policies.
  3. **Image Scanning** â†’ ensure container images donâ€™t contain vulnerabilities.

---

## **2. Pod Security Standards (PSS)**

PSS replaced old **PodSecurityPolicy (PSP)**.
It defines **three security levels**:

| Level          | Description                                               |
| -------------- | --------------------------------------------------------- |
| **Privileged** | No restrictions (not recommended).                        |
| **Baseline**   | Prevent known privilege escalations (reasonable default). |
| **Restricted** | Enforces strong isolation (recommended for production).   |

---

### **2.1 Applying Pod Security Standards**

They are applied using **labels on namespaces**:

```bash
kubectl label namespace dev pod-security.kubernetes.io/enforce=restricted
kubectl label namespace dev pod-security.kubernetes.io/enforce-version=latest
```

ðŸ‘‰ Now any pod created in `dev` namespace must meet **restricted policy** (or it will be denied).

---

### **2.2 Example: Restricted Pod vs. Non-Compliant Pod**

#### Non-compliant Pod (runs as root):

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: root-pod
spec:
  containers:
  - name: bad
    image: busybox
    command: ["sh", "-c", "sleep 3600"]
    securityContext:
      privileged: true
```

ðŸ‘‰ If namespace has `restricted` PSS, this pod will be **rejected**.

---

#### Compliant Pod (restricted):

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: safe-pod
spec:
  securityContext:
    runAsNonRoot: true
    fsGroup: 2000
  containers:
  - name: good
    image: busybox
    command: ["sh", "-c", "sleep 3600"]
    securityContext:
      allowPrivilegeEscalation: false
      runAsUser: 1000
```

---

## **3. Pod Security Contexts**

You can define **security settings at pod or container level**:

* **Pod-level securityContext** â†’ applies to all containers.
* **Container-level securityContext** â†’ applies only to that container.

Common options:

* `runAsUser: 1000` â†’ run as non-root user
* `runAsNonRoot: true`
* `readOnlyRootFilesystem: true`
* `allowPrivilegeEscalation: false`
* `capabilities: drop: ["ALL"]`

ðŸ‘‰ Always combine these with PSS.

---

## **4. Admission Controllers for Advanced Policies**

For complex org needs:

* **OPA Gatekeeper** â†’ Policy as Code using Rego.
* **Kyverno** â†’ Easy Kubernetes-native policies (YAML).
* Example Kyverno policy (block privileged pods):

```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-privileged
spec:
  validationFailureAction: enforce
  rules:
  - name: privileged
    match:
      resources:
        kinds:
        - Pod
    validate:
      message: "Privileged containers are not allowed"
      pattern:
        spec:
          containers:
          - =(securityContext):
              =(privileged): "false"
```

---

## **5. Image Scanning with Trivy**

### **5.1 Why scan images?**

* Container images often have:

  * OS-level vulnerabilities (CVEs).
  * Outdated packages.
  * Secrets embedded accidentally.
* Scanning ensures you **donâ€™t deploy vulnerable apps**.

---

### **5.2 Install Trivy**

On Linux/macOS:

```bash
brew install aquasecurity/trivy/trivy
```

or

```bash
apt install trivy -y
```

---

### **5.3 Scan an Image**

```bash
trivy image nginx:latest
```

ðŸ‘‰ Example output:

* Lists **HIGH, CRITICAL, MEDIUM vulnerabilities**
* Suggests **fixed versions**

---

### **5.4 Scan a Pod/Deployment**

```bash
trivy k8s cluster
trivy k8s --namespace default
trivy k8s pod nginx-pod
```

---

### **5.5 Scan Infrastructure Files (IaC)**

```bash
trivy config .
```

ðŸ‘‰ Scans Helm charts, manifests, Terraform for misconfigurations.

---

## **6. Hands-On Lab**

1. Label namespace for security:

   ```bash
   kubectl create ns dev
   kubectl label ns dev pod-security.kubernetes.io/enforce=restricted
   ```

2. Try deploying a bad pod:

   ```bash
   kubectl apply -f root-pod.yaml -n dev
   ```

   ðŸ‘‰ Should fail.

3. Deploy compliant pod:

   ```bash
   kubectl apply -f safe-pod.yaml -n dev
   ```

4. Run image scan:

   ```bash
   trivy image nginx:latest
   trivy k8s --namespace dev
   ```

---

## **7. Best Practices**

âœ… Always enforce **PodSecurity restricted** in production.
âœ… Use **Kyverno/OPA** for fine-grained policies.
âœ… Make **Trivy scans part of CI/CD pipeline** (block deployment if CRITICAL vulns).
âœ… Use **signed images** (cosign, Notary) + private registry.
âœ… Drop all **Linux capabilities** not needed by apps.
âœ… Run containers as **non-root with read-only filesystem**.

---

## **8. Troubleshooting**

* Pod rejected with error:

  ```text
  failed to create: pods "root-pod" is forbidden: violates PodSecurity "restricted"
  ```

  ðŸ‘‰ Fix securityContext.

* Trivy scan fails:
  ðŸ‘‰ Check internet access or registry authentication.

* Too many vulnerabilities:
  ðŸ‘‰ Use a **smaller base image** (`alpine`, `distroless`).

---

## **9. Key Takeaways**

* **Pod Security Standards** protect against privilege escalation.
* **SecurityContext** gives fine control (non-root, drop caps, read-only).
* **Trivy** detects vulnerabilities in images, clusters, IaC.
* Combined â†’ strong **workload security posture**.


